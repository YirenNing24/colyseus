{
  "version": 3,
  "sources": ["../src/WebSocketClient.ts"],
  "sourcesContent": ["// <reference types=\"bun-types\" />\n\n// \"bun-types\" is currently conflicting with \"ws\" types.\n// @ts-ignore\nimport { ServerWebSocket } from \"bun\";\nimport EventEmitter from 'events';\n\nimport { Protocol, Client, ClientState, ISendOptions, getMessageBytes, logger, debugMessage } from '@colyseus/core';\nimport { Schema } from '@colyseus/schema';\n\nexport class WebSocketWrapper extends EventEmitter {\n  constructor(public ws: ServerWebSocket<any>) {\n    super();\n  }\n}\n\nexport class WebSocketClient implements Client {\n  public sessionId: string;\n  public state: ClientState = ClientState.JOINING;\n  public _enqueuedMessages: any[] = [];\n  public _afterNextPatchQueue;\n  public _reconnectionToken: string;\n\n  constructor(\n    public id: string,\n    public ref: WebSocketWrapper,\n  ) {\n    this.sessionId = id;\n  }\n\n  public sendBytes(type: string | number, bytes: number[] | Uint8Array, options?: ISendOptions) {\n    debugMessage(\"send bytes(to %s): '%s' -> %j\", this.sessionId, type, bytes);\n\n    this.enqueueRaw(\n      getMessageBytes.raw(Protocol.ROOM_DATA_BYTES, type, undefined, bytes),\n      options,\n    );\n  }\n\n  public send(messageOrType: any, messageOrOptions?: any | ISendOptions, options?: ISendOptions) {\n    debugMessage(\"send(to %s): '%s' -> %j\", this.sessionId, messageOrType, messageOrOptions);\n\n    this.enqueueRaw(\n      (messageOrType instanceof Schema)\n        ? getMessageBytes[Protocol.ROOM_DATA_SCHEMA](messageOrType)\n        : getMessageBytes.raw(Protocol.ROOM_DATA, messageOrType, messageOrOptions),\n      options,\n    );\n  }\n\n  public enqueueRaw(data: ArrayLike<number>, options?: ISendOptions) {\n    // use room's afterNextPatch queue\n    if (options?.afterNextPatch) {\n      this._afterNextPatchQueue.push([this, arguments]);\n      return;\n    }\n\n    if (this.state === ClientState.JOINING) {\n      // sending messages during `onJoin`.\n      // - the client-side cannot register \"onMessage\" callbacks at this point.\n      // - enqueue the messages to be send after JOIN_ROOM message has been sent\n      this._enqueuedMessages.push(data);\n      return;\n    }\n\n    this.raw(data, options);\n  }\n\n  public raw(data: ArrayLike<number>, options?: ISendOptions, cb?: (err?: Error) => void) {\n    // skip if client not open\n\n    // WebSocket is globally available on Bun runtime\n    // @ts-ignore\n    if (this.ref.ws.readyState !== WebSocket.OPEN) {\n      return;\n    }\n\n    // FIXME: can we avoid creating a new buffer here?\n    this.ref.ws.sendBinary(Buffer.from(data as unknown as ArrayBufferLike));\n  }\n\n  public error(code: number, message: string = '', cb?: (err?: Error) => void) {\n    this.raw(getMessageBytes[Protocol.ERROR](code, message), undefined, cb);\n  }\n\n  get readyState() {\n    return this.ref.ws.readyState;\n  }\n\n  public leave(code?: number, data?: string) {\n    this.ref.ws.close(code, data);\n  }\n\n  public close(code?: number, data?: string) {\n    logger.warn('DEPRECATION WARNING: use client.leave() instead of client.close()');\n    try {\n      throw new Error();\n    } catch (e) {\n      logger.info(e.stack);\n    }\n    this.leave(code, data);\n  }\n\n  public toJSON() {\n    return { sessionId: this.sessionId, readyState: this.readyState };\n  }\n}\n"],
  "mappings": "AAKA,OAAO,kBAAkB;AAEzB,SAAS,UAAkB,aAA2B,iBAAiB,QAAQ,oBAAoB;AACnG,SAAS,cAAc;AAEhB,MAAM,yBAAyB,aAAa;AAAA,EACjD,YAAmB,IAA0B;AAC3C,UAAM;AADW;AAAA,EAEnB;AACF;AAEO,MAAM,gBAAkC;AAAA,EAO7C,YACS,IACA,KACP;AAFO;AACA;AAPT,SAAO,QAAqB,YAAY;AACxC,SAAO,oBAA2B,CAAC;AAQjC,SAAK,YAAY;AAAA,EACnB;AAAA,EAEO,UAAU,MAAuB,OAA8B,SAAwB;AAC5F,iBAAa,iCAAiC,KAAK,WAAW,MAAM,KAAK;AAEzE,SAAK;AAAA,MACH,gBAAgB,IAAI,SAAS,iBAAiB,MAAM,QAAW,KAAK;AAAA,MACpE;AAAA,IACF;AAAA,EACF;AAAA,EAEO,KAAK,eAAoB,kBAAuC,SAAwB;AAC7F,iBAAa,2BAA2B,KAAK,WAAW,eAAe,gBAAgB;AAEvF,SAAK;AAAA,MACF,yBAAyB,SACtB,gBAAgB,SAAS,kBAAkB,aAAa,IACxD,gBAAgB,IAAI,SAAS,WAAW,eAAe,gBAAgB;AAAA,MAC3E;AAAA,IACF;AAAA,EACF;AAAA,EAEO,WAAW,MAAyB,SAAwB;AAEjE,QAAI,SAAS,gBAAgB;AAC3B,WAAK,qBAAqB,KAAK,CAAC,MAAM,SAAS,CAAC;AAChD;AAAA,IACF;AAEA,QAAI,KAAK,UAAU,YAAY,SAAS;AAItC,WAAK,kBAAkB,KAAK,IAAI;AAChC;AAAA,IACF;AAEA,SAAK,IAAI,MAAM,OAAO;AAAA,EACxB;AAAA,EAEO,IAAI,MAAyB,SAAwB,IAA4B;AAKtF,QAAI,KAAK,IAAI,GAAG,eAAe,UAAU,MAAM;AAC7C;AAAA,IACF;AAGA,SAAK,IAAI,GAAG,WAAW,OAAO,KAAK,IAAkC,CAAC;AAAA,EACxE;AAAA,EAEO,MAAM,MAAc,UAAkB,IAAI,IAA4B;AAC3E,SAAK,IAAI,gBAAgB,SAAS,OAAO,MAAM,OAAO,GAAG,QAAW,EAAE;AAAA,EACxE;AAAA,EAEA,IAAI,aAAa;AACf,WAAO,KAAK,IAAI,GAAG;AAAA,EACrB;AAAA,EAEO,MAAM,MAAe,MAAe;AACzC,SAAK,IAAI,GAAG,MAAM,MAAM,IAAI;AAAA,EAC9B;AAAA,EAEO,MAAM,MAAe,MAAe;AACzC,WAAO,KAAK,mEAAmE;AAC/E,QAAI;AACF,YAAM,IAAI,MAAM;AAAA,IAClB,SAAS,GAAP;AACA,aAAO,KAAK,EAAE,KAAK;AAAA,IACrB;AACA,SAAK,MAAM,MAAM,IAAI;AAAA,EACvB;AAAA,EAEO,SAAS;AACd,WAAO,EAAE,WAAW,KAAK,WAAW,YAAY,KAAK,WAAW;AAAA,EAClE;AACF;",
  "names": []
}
